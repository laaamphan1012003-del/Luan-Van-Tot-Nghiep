name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${SSH_PORT:-22} $SSH_HOST >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER: ${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        run: |
          # Create deployment directory on VPS
          DEPLOY_DIR="${DEPLOY_PATH:-/home/$SSH_USER/ocpp-csms}"
          ssh -p ${SSH_PORT:-22} $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_DIR"
          
          # Sync files to VPS (excluding unnecessary files)
          rsync -avz --delete \
            -e "ssh -p ${SSH_PORT:-22}" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='github_secrets.txt' \
            --exclude='DEPLOYMENT_SUMMARY.txt' \
            ./ $SSH_USER@$SSH_HOST:$DEPLOY_DIR/
          
          # Execute deployment commands on VPS
          ssh -p ${SSH_PORT:-22} $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e
            
            # Colors for output
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m' # No Color
            
            echo -e "${GREEN}=== Starting deployment ===${NC}"
            
            # Navigate to deployment directory
            DEPLOY_DIR="${DEPLOY_PATH:-$HOME/ocpp-csms}"
            cd $DEPLOY_DIR
            
            # Verify Docker is available
            docker --version
            docker compose version
            
            # Create .env file
            echo -e "${YELLOW}Creating .env file...${NC}"
            cat > .env << 'EOF'
          MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-L@m0981985353}
          MYSQL_DATABASE=${MYSQL_DATABASE:-ocpp_csms}
          MYSQL_USER=${MYSQL_USER:-ocpp_user}
          MYSQL_PASSWORD=${MYSQL_PASSWORD:-ocpp_pass}
          EOF
            
            # Stop existing containers
            echo -e "${YELLOW}Stopping existing containers...${NC}"
            docker compose down || true
            
            # Pull latest images and build
            echo -e "${YELLOW}Building and starting containers...${NC}"
            docker compose up -d --build
            
            # Wait for services to be healthy
            echo -e "${YELLOW}Waiting for services to start...${NC}"
            sleep 10
            
            # Check container status
            echo -e "${GREEN}=== Container Status ===${NC}"
            docker compose ps
            
            # Show logs
            echo -e "${GREEN}=== Recent Logs ===${NC}"
            docker compose logs --tail=20
            
            echo -e "${GREEN}=== Deployment Complete ===${NC}"
            echo -e "${GREEN}Application should be accessible at: http://$SSH_HOST:9000${NC}"
          ENDSSH

      - name: Verify Deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -p ${SSH_PORT:-22} $SSH_USER@$SSH_HOST << 'ENDSSH'
            DEPLOY_DIR="${DEPLOY_PATH:-$HOME/ocpp-csms}"
            cd $DEPLOY_DIR
            
            # Check if containers are running
            if docker compose ps | grep -q "Up"; then
              echo "✅ Containers are running"
              exit 0
            else
              echo "❌ Containers failed to start"
              docker compose logs --tail=50
              exit 1
            fi
          ENDSSH

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
